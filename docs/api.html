<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenRSVP Docs – JSON API</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark py-3">
      <div class="container">
        <a class="navbar-brand" href="index.html">OpenRSVP Docs</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="nav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
            <li class="nav-item"><a class="nav-link" href="web-app.html">Web App</a></li>
            <li class="nav-item"><a class="nav-link" href="calendar.html">Calendar</a></li>
            <li class="nav-item"><a class="nav-link" href="capacity.html">Capacity</a></li>
            <li class="nav-item"><a class="nav-link" href="rsvp-close.html">RSVP Close</a></li>
            <li class="nav-item"><a class="nav-link" href="deploy.html">Deploy</a></li>
            <li class="nav-item"><a class="nav-link" href="cli.html">CLI &amp; Ops</a></li>
            <li class="nav-item"><a class="nav-link" href="decay.html">Decay</a></li>
            <li class="nav-item"><a class="nav-link active" aria-current="page" href="api.html">API</a></li>
            <li class="nav-item"><a class="nav-link" href="tokens.html">Tokens</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container my-5">
      <section class="my-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="text-uppercase text-muted mb-1 small fw-semibold">API</p>
            <h1 class="fw-bold mb-0">JSON API for third-party builders</h1>
            <p class="text-muted mb-0">Base path: <code>/api/v1</code> · JSON only · Bearer tokens for capability links.</p>
          </div>
          <span class="pill"><span class="text-primary">Auth</span> Bearer token</span>
        </div>

        <div class="row g-4">
          <div class="col-lg-6">
            <div class="section-card h-100">
              <h3 class="h5">Authentication</h3>
              <ul class="mb-3">
                <li><strong>Event owner token</strong> (admin token) → required for editing/deleting events or listing/deleting RSVPs: <code>Authorization: Bearer &lt;event-owner-token&gt;</code>.</li>
                <li><strong>RSVP token</strong> → required for managing your own RSVP at <code>/events/{event_id}/rsvps/self</code>.</li>
                <li>No root-level API; root admin stays CLI-only.</li>
              </ul>
              <p class="mb-2 text-muted small"><strong>Note:</strong> the root admin token can stand in anywhere an event owner token is required.</p>
              <div class="callout mb-2">
                <strong>Tip:</strong> send ISO timestamps; include <code>timezone_offset_minutes</code> when creating/updating events so local times are stored correctly in UTC.
              </div>
              <p class="mb-2 text-muted small">Private RSVPs are hidden from <code>GET /api/v1/events/{id}</code> but are visible when using the event owner endpoints.</p>
              <p class="mb-0 text-muted small">Public responses omit private channel metadata and redact locations for approval-required events unless you send an admin/root token or an approved Yes RSVP token.</p>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="section-card h-100">
              <h3 class="h5">Key endpoints</h3>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">POST</span>/api/v1/events</span> Create event; returns the event owner (admin) token + links.</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">GET</span>/api/v1/events</span> List public events with pagination and date filters.</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">GET</span>/api/v1/events/{event_id}</span> Public event detail + public RSVPs.</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">PATCH</span>/api/v1/events/{event_id}</span> Update event (event owner bearer).</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">DELETE</span>/api/v1/events/{event_id}</span> Delete event (event owner bearer).</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">GET</span>/api/v1/events/{event_id}/rsvps</span> List RSVPs + stats (event owner bearer).</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">POST</span>/api/v1/events/{event_id}/rsvps</span> Create RSVP; returns token + links.</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">GET/PATCH/DELETE</span>/api/v1/events/{event_id}/rsvps/self</span> Manage your own RSVP (rsvp bearer).</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">POST</span>/api/v1/events/{event_id}/rsvps/{rsvp_id}/approve|reject|pending</span> Update approval state (event owner bearer).</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">GET</span>/api/v1/events/{event_id}/event.ics</span> Download the event as an ICS file.</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">POST</span>/api/v1/events/{event_id}/messages</span> Create a public/admin event announcement.</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">POST</span>/api/v1/events/{event_id}/rsvps/{rsvp_id}/messages</span> Send a direct message or admin note.</div>
              <div class="mb-2"><span class="endpoint"><span class="method text-primary">POST</span>/api/v1/events/{event_id}/rsvps/self/messages</span> Attendee message to the organizer.</div>
              <div class="mb-0"><span class="endpoint"><span class="method text-primary">GET</span>/api/v1/channels</span> Public channels with pagination; filter via <code>?q=</code>.</div>
              <div class="mt-2"><span class="endpoint"><span class="method text-primary">GET</span>/api/v1/channels/{slug}</span> Channel detail + events (public or private based on slug visibility).</div>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-1">
          <div class="col-lg-6">
            <div class="section-card h-100">
              <h3 class="h5">Create an event</h3>
              <p class="mb-2">Send ISO8601 times. Pass <code>timezone_offset_minutes</code> (e.g., browser timezone offset) so local times normalize to UTC.</p>
              <pre><code>curl -X POST http://localhost:8000/api/v1/events \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Cedar Social: Cigar Night",
    "description": "Monthly hang at the lounge.",
    "start_time": "2024-08-22T19:00:00",
    "end_time": "2024-08-22T21:30:00",
    "timezone_offset_minutes": -300,
    "location": "Cedar Social, Austin",
    "channel_name": "ATX Cigars",
    "channel_visibility": "public",
    "is_private": false
  }'</code></pre>
              <div class="callout mb-0">
                Response includes <code>admin_token</code> (the event owner token) plus <code>links.admin</code> for the owner page and <code>links.public</code> for the guest view.
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="section-card h-100">
              <h3 class="h5">Create an RSVP</h3>
              <p class="mb-2">No auth required to submit; the response includes the RSVP token.</p>
              <pre><code>curl -X POST http://localhost:8000/api/v1/events/{event_id}/rsvps \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Sky",
    "status": "yes",
    "pronouns": "they/them",
    "guest_count": 1,
    "notes": "Can bring a projector",
    "is_private_rsvp": false
  }'</code></pre>
              <p class="mb-2">Guests manage their own entry at <code>/api/v1/events/{event_id}/rsvps/self</code> using <code>Authorization: Bearer &lt;rsvp-token&gt;</code>. Responses include <code>approval_status</code> (approved/pending/rejected).</p>
              <pre><code>curl -X PATCH http://localhost:8000/api/v1/events/{event_id}/rsvps/self \
  -H "Authorization: Bearer &lt;rsvp-token&gt;" \
  -H "Content-Type: application/json" \
  -d '{"status": "no", "notes": "Out of town"}'</code></pre>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-1">
          <div class="col-lg-6">
            <div class="section-card h-100">
              <h3 class="h5">List public events</h3>
              <p class="mb-2">Returns only public (non-private) events with pagination. <code>per_page</code> is capped to prevent huge responses.</p>
              <pre><code>curl "http://localhost:8000/api/v1/events?page=1&per_page=10"</code></pre>
              <p class="mb-0 text-muted small">Private events never appear in this listing; they remain reachable only via their exact IDs or the root admin UI. Approval-required events return <code>location: null</code> until an approved Yes token (or admin/root token) is supplied, and counts only include approved RSVPs.</p>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="section-card h-100">
              <h3 class="h5">Filter by date range</h3>
              <p class="mb-2">Use ISO8601 timestamps to bound start times. Both parameters are optional.</p>
              <pre><code>curl "http://localhost:8000/api/v1/events?start_after=2024-08-01T00:00:00&start_before=2024-08-31T23:59:59"</code></pre>
              <p class="mb-0 text-muted small"><code>start_before</code> must be after <code>start_after</code>. The response echoes pagination and the applied filters.</p>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-1">
          <div class="col-lg-6">
            <div class="section-card h-100">
              <h3 class="h5">Event owner actions on events</h3>
              <p class="mb-2">Use the event owner token (admin token) as a bearer to edit or delete.</p>
              <p class="mb-2 text-muted small">Third-party apps can delete events the same way the owner UI does by calling the DELETE endpoint with the event owner token.</p>
              <pre><code>curl -X PATCH http://localhost:8000/api/v1/events/{event_id} \
  -H "Authorization: Bearer &lt;event-owner-token&gt;" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Updated title",
    "channel_name": "Private Circle",
    "channel_visibility": "private",
    "is_private": true
  }'</code></pre>
              <p class="mb-0 text-muted small">Deleting an event (<code>DELETE /api/v1/events/{id}</code>) removes the event and all RSVPs. This is irreversible.</p>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="section-card h-100">
              <h3 class="h5">List RSVPs with stats (event owner)</h3>
              <p class="mb-2">Returns RSVP records (including private ones) plus convenience counts.</p>
              <pre><code>curl http://localhost:8000/api/v1/events/{event_id}/rsvps \
  -H "Authorization: Bearer &lt;event-owner-token&gt;"</code></pre>
              <p class="mb-2">Events with approval enabled include <code>approval_status</code> on each RSVP; pending/rejected entries stay off the public attendee list.</p>
              <p class="mb-2">Example stats payload:</p>
              <pre><code>{
  "stats": {
    "yes_count": 6,
    "yes_guest_count": 3,
    "yes_total": 9,
    "maybe_count": 2,
    "no_count": 1
  }
}</code></pre>
              <p class="mb-0 text-muted small">Event owners can delete specific RSVPs via <code>DELETE /api/v1/events/{event_id}/rsvps/{rsvp_token}</code>.</p>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-1">
          <div class="col-lg-12">
            <div class="section-card h-100">
              <h3 class="h5">Approve or reject pending RSVPs</h3>
              <p class="mb-2">When <strong>Require admin approval</strong> is enabled, new RSVPs enter the pending queue until an event owner (or root admin token) sends one of the approval endpoints below.</p>
              <ul class="mb-3">
                <li><code>POST /api/v1/events/{event_id}/rsvps/{rsvp_id}/approve</code> — marks the RSVP approved and adds an owner-visible log entry.</li>
                <li><code>POST /api/v1/events/{event_id}/rsvps/{rsvp_id}/reject</code> — accepts optional JSON body <code>{"reason": "Capacity reached"}</code> that is shared with the attendee.</li>
                <li><code>POST /api/v1/events/{event_id}/rsvps/{rsvp_id}/pending</code> — moves the RSVP back into the pending state.</li>
              </ul>
              <p class="mb-2 text-muted small">All three routes require <code>Authorization: Bearer &lt;event-owner-token&gt;</code> or the root admin token from <code>docker exec openrsvp openrsvp admin-token</code>. Responses return the updated RSVP plus its attendee-facing messages.</p>
              <pre><code>curl -X POST http://localhost:8000/api/v1/events/{event_id}/rsvps/{rsvp_id}/approve \
  -H "Authorization: Bearer &lt;event-owner-token&gt;"</code></pre>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-1">
          <div class="col-lg-12">
            <div class="section-card h-100">
              <h3 class="h5">Messages API</h3>
              <p class="mb-2">Send announcements or direct messages between hosts and attendees.</p>
              <ul class="mb-3">
                <li><code>POST /api/v1/events/{event_id}/messages</code> — event announcements (visibility: public or admin).</li>
                <li><code>POST /api/v1/events/{event_id}/rsvps/{rsvp_id}/messages</code> — admin notes or direct messages to a guest.</li>
                <li><code>POST /api/v1/events/{event_id}/rsvps/self/messages</code> — attendee message to the organizer.</li>
              </ul>
              <pre><code>curl -X POST http://localhost:8000/api/v1/events/{event_id}/messages \
  -H "Authorization: Bearer &lt;event-owner-token&gt;" \
  -H "Content-Type: application/json" \
  -d '{"content": "Doors open 15 minutes early.", "visibility": "public", "message_type": "event_update"}'</code></pre>
              <p class="mb-0 text-muted small">Event detail responses include public announcements in <code>messages</code>; RSVP detail responses include attendee-visible messages.</p>
            </div>
          </div>
        </div>
      </section>

      <div class="divider my-5"></div>
      <p class="footer text-center mb-4">
        <a href="https://openrsvp.kaotic.cc/">OpenRSVP</a> ·
        <a href="https://fastapi.tiangolo.com/">FastAPI</a> ·
        <a href="https://www.sqlite.org/">SQLite</a> ·
        <a href="https://catppuccin.com/">Catppuccin Latte</a>
      </p>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
