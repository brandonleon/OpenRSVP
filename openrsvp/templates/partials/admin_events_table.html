{% if events %}
  {% set start_index = ((pagination.page - 1) * pagination.per_page) + 1 %}
  {% set end_index = start_index + events|length - 1 %}
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <span class="text-muted small">Showing {{ start_index }}&ndash;{{ end_index }} of {{ pagination.total_events }}</span>
    {% if pagination.query %}
    <span class="badge bg-secondary text-uppercase">Filter: {{ pagination.query }}</span>
    {% endif %}
  </div>
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead>
        <tr>
          <th scope="col">Event</th>
          <th scope="col">Timeline</th>
          <th scope="col">Visibility</th>
          <th scope="col">Channel</th>
          <th scope="col">Yes</th>
          <th scope="col">Maybe</th>
          <th scope="col">Score</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for event in events %}
        {% set admin_url = request.url_for('event_admin', event_id=event.id, admin_token=event.admin_token) %}
        {% set event_url = request.url_for('event_page', event_id=event.id) %}
        {% if event.channel %}
        {% if event.channel.visibility == 'private' %}
        {% set channel_url = request.url_for('channel_page_private', slug=event.channel.slug) %}
        {% else %}
        {% set channel_url = request.url_for('channel_page', slug=event.channel.slug) %}
        {% endif %}
        {% else %}
          {% set channel_url = None %}
        {% endif %}
        {% set totals = namespace(yes=0, maybe=0) %}
        {% set pending_count = event.rsvps | selectattr('approval_status', 'equalto', 'pending') | list | length %}
        {% for rsvp in event.rsvps %}
          {% if rsvp.approval_status != 'approved' %}
            {% continue %}
          {% endif %}
          {% set status = (rsvp.attendance_status or '').lower() %}
          {% set party_size = (rsvp.guest_count or 0) + 1 %}
          {% if status == 'yes' %}
            {% set totals.yes = totals.yes + party_size %}
          {% elif status == 'maybe' %}
            {% set totals.maybe = totals.maybe + party_size %}
          {% endif %}
        {% endfor %}
        <tr>
          <td>
            <div class="fw-semibold">{{ event.title }}</div>
            <div class="small text-muted">
              ID: <code>{{ event.id }}</code>
              {% if event.location %}&middot; {{ event.location }}{% endif %}
              {% if event.admin_approval_required %}
              <span class="badge bg-warning text-dark text-uppercase ms-1">Approval required</span>
              {% endif %}
              {% if pending_count %}
              <div class="mt-1"><span class="badge bg-light text-dark">{{ pending_count }} pending</span></div>
              {% endif %}
            </div>
          </td>
          <td>
            <div
              class="js-event-time"
              data-event-utc="{{ event.start_time.isoformat(timespec='seconds') }}Z"
            >
              <div class="js-event-absolute">{{ event.start_time.strftime('%Y-%m-%d %H:%M') }}</div>
              <div class="text-muted small js-event-relative" data-placeholder="Calculating...">Calculating...</div>
              {% if event.end_time %}
              <div class="text-muted small">Duration: {{ event.start_time|duration(event.end_time) }}</div>
              {% endif %}
            </div>
          </td>
          <td>
            <span class="badge {% if event.is_private %}bg-warning text-dark{% else %}bg-success{% endif %}">
              {{ 'Private' if event.is_private else 'Public' }}
            </span>
          </td>
          <td>
            {% if event.channel %}
              <a href="{{ channel_url }}">{{ event.channel.name }}</a>
            {% else %}
              <span class="text-muted">&mdash;</span>
            {% endif %}
          </td>
          <td>{{ totals.yes }}</td>
          <td>{{ totals.maybe }}</td>
          <td>{{ '%.2f'|format(event.score) }}</td>
          <td>
            <div class="d-flex flex-wrap gap-2">
              <a class="btn btn-outline-primary btn-sm" href="{{ admin_url }}">Admin</a>
              <a class="btn btn-outline-secondary btn-sm" href="{{ event_url }}">View</a>
              <form method="post" action="/admin/{{ root_token }}/events/{{ event.id }}/delete" onsubmit="return confirm('Force delete this event?');">
                <button class="btn btn-danger btn-sm" type="submit">Delete</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if pagination.total_pages > 1 %}
  <nav class="d-flex flex-wrap justify-content-between align-items-center mt-3 gap-2">
    <span class="text-muted small">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
    <div class="d-flex gap-2">
      {% if pagination.has_prev %}
        <button
          type="button"
          class="btn btn-outline-secondary btn-sm"
          hx-get="/admin/{{ root_token }}/events?page={{ pagination.prev_page }}{% if pagination.query %}&q={{ pagination.query | urlencode }}{% endif %}"
          hx-target="#events-table-wrapper"
          hx-indicator="#events-search-indicator"
        >
          Previous
        </button>
      {% else %}
        <span class="btn btn-outline-secondary btn-sm disabled">Previous</span>
      {% endif %}
      {% if pagination.has_next %}
        <button
          type="button"
          class="btn btn-outline-secondary btn-sm"
          hx-get="/admin/{{ root_token }}/events?page={{ pagination.next_page }}{% if pagination.query %}&q={{ pagination.query | urlencode }}{% endif %}"
          hx-target="#events-table-wrapper"
          hx-indicator="#events-search-indicator"
        >
          Next
        </button>
      {% else %}
        <span class="btn btn-outline-secondary btn-sm disabled">Next</span>
      {% endif %}
    </div>
  </nav>
  {% endif %}
{% else %}
  <p class="text-muted mb-0">No events found.</p>
{% endif %}
