{% set alt_row = alt_row if alt_row is defined else False %}
{% set messages = messages if messages is defined else [] %}
<li
  class="list-group-item border-0 px-0 py-0"
  data-approval-status="{{ rsvp.approval_status }}"
  data-rsvp-id="{{ rsvp.id }}"
  data-rsvp-card
>
  <div class="rsvp-card border rounded-3 p-3 shadow-sm {% if alt_row %}bg-dark bg-opacity-10 alt-row{% endif %}">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <div class="fw-semibold">{{ rsvp.name }}</div>
        {% if rsvp.pronouns %}<div class="text-muted small">{{ rsvp.pronouns }}</div>{% endif %}
        <div class="text-muted small">Guests: {{ rsvp.guest_count }}</div>
        <div class="text-muted small">Attendance: {{ rsvp.attendance_status|capitalize }}</div>
      </div>
      <div class="text-end">
        <div class="d-flex flex-wrap justify-content-end gap-1">
          <span class="badge {% if rsvp.approval_status == 'approved' %}bg-success{% elif rsvp.approval_status == 'rejected' %}bg-danger{% else %}bg-warning text-dark{% endif %} text-uppercase" data-rsvp-approval-badge>
            {{ rsvp.approval_status }}
          </span>
          <span class="badge bg-secondary text-uppercase">{{ rsvp.attendance_status }}</span>
          {% if rsvp.is_private %}
          <span class="badge bg-dark text-uppercase">Private</span>
          {% endif %}
        </div>
        <form
          id="reject-form-{{ rsvp.id }}"
          method="post"
          action="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/reject"
          class="mb-2"
          hx-post="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/reject"
          hx-target="closest [data-rsvp-card]"
          hx-swap="outerHTML"
        >
          <input
            type="text"
            name="reason"
            class="form-control form-control-sm"
            placeholder="Rejection reason (optional)"
          >
        </form>
        <div class="d-flex flex-wrap justify-content-end gap-2">
          <form
            method="post"
            action="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/approve"
            hx-post="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/approve"
            hx-target="closest [data-rsvp-card]"
            hx-swap="outerHTML"
          >
            <button class="btn btn-outline-success btn-sm" type="submit">Approve</button>
          </form>
          <form
            method="post"
            action="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/pending"
            hx-post="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/pending"
            hx-target="closest [data-rsvp-card]"
            hx-swap="outerHTML"
          >
            <button class="btn btn-outline-warning btn-sm" type="submit">Pending</button>
          </form>
          {% if event.max_attendees and rsvp.attendance_status != 'yes' %}
          <form method="post" action="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/force_accept">
            <button class="btn btn-outline-warning btn-sm" type="submit" {% if not event_is_full %}data-bs-toggle="tooltip" title="Bypass the cap and mark as Yes"{% endif %}>
              Force Accept
            </button>
          </form>
          {% endif %}
          <button class="btn btn-outline-danger btn-sm" type="submit" form="reject-form-{{ rsvp.id }}">Reject</button>
        </div>
        <form
          method="post"
          action="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/delete"
          onsubmit="return confirm('Delete this RSVP?');"
          class="mt-2"
        >
          <button
            class="btn btn-sm btn-outline-danger"
            type="submit"
            data-bs-toggle="tooltip"
            title="Deletes this RSVP; guest must submit a new one to rejoin."
          >
            Delete
          </button>
        </form>
      </div>
    </div>
    <div class="mt-3">
      <form
        method="post"
        action="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/note"
        hx-post="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/note"
        hx-target="closest [data-rsvp-card]"
        hx-swap="outerHTML"
      >
        <label class="form-label small fw-semibold">Add admin note</label>
        <div class="d-flex gap-2 flex-wrap">
          <textarea name="content" class="form-control" rows="2" placeholder="Private note for admins" required></textarea>
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
    <div class="mt-3">
      <form
        method="post"
        action="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/message"
        hx-post="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/message"
        hx-target="closest [data-rsvp-card]"
        hx-swap="outerHTML"
      >
        <label class="form-label small fw-semibold">Message guest</label>
        <div class="d-flex gap-2 flex-wrap">
          <textarea name="content" class="form-control" rows="2" placeholder="Visible to this guest via their RSVP link" required></textarea>
          <button class="btn btn-outline-primary" type="submit">Send</button>
        </div>
      </form>
    </div>
    {% if messages %}
    <div class="mt-3">
      <div class="small text-muted text-uppercase mb-1">Messages</div>
      <div class="list-group list-group-flush">
        {% for message in messages %}
        <div class="list-group-item px-0">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-semibold">{{ message.content }}</div>
              <div class="small text-muted">{{ message.created_at|relative_time }} &middot; {{ message.visibility }}</div>
            </div>
            <span class="badge bg-light text-dark text-uppercase">{{ message.message_type }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</li>
