{% extends "base.html" %}
{% block content %}
<section class="hero-panel p-4 p-md-5 rounded-4 mb-4">
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
    <div>
      <p class="text-uppercase small mb-2 fw-semibold text-secondary" style="letter-spacing: 0.08em;">Admin</p>
      <h1 class="display-6 fw-semibold text-white mb-2">{{ event.title }}</h1>
      <div class="text-secondary small">This magic link controls the event. Keep it private.</div>
    </div>
    <div class="text-end text-secondary small">
      <div class="badge badge-soft text-uppercase">Event admin</div>
      <div class="mt-2">RSVPs: {{ rsvps|length }}</div>
      {% if event.is_private %}<div class="mt-1 badge bg-warning text-dark text-uppercase">Private event</div>{% endif %}
    </div>
  </div>
</section>
<div class="row g-4">
  <div class="col-lg-7">
    <div class="p-4 bg-white border rounded-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h5 mb-0">Event details</h3>
        <a class="btn btn-outline-secondary btn-sm" href="/e/{{ event.id }}">View event</a>
      </div>
      <form method="post" action="/e/{{ event.id }}/admin/{{ admin_token }}">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" name="title" class="form-control" value="{{ event.title }}" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3">{{ event.description or '' }}</textarea>
          <div class="form-text">Supports basic Markdown.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Start Time</label>
          <input
            type="datetime-local"
            name="start_time"
            class="form-control"
            value="{{ event.start_time.strftime('%Y-%m-%dT%H:%M') }}"
            data-utc-input="{{ event.start_time.isoformat(timespec='seconds') }}Z"
            required
          >
          <input type="hidden" name="timezone_offset_minutes" data-tz-input>
        </div>
        <div class="mb-3">
          <label class="form-label">End Time (optional)</label>
          <input
            type="datetime-local"
            name="end_time"
            class="form-control"
            value="{{ event.end_time.strftime('%Y-%m-%dT%H:%M') if event.end_time else '' }}"
            data-utc-input="{{ event.end_time.isoformat(timespec='seconds') + 'Z' if event.end_time else '' }}"
          >
          <div class="form-text">Leave blank if this event does not have a defined end.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Location</label>
          <input type="text" name="location" class="form-control" value="{{ event.location or '' }}">
        </div>
        <div class="mb-3">
          <label class="form-label" for="admin-channel-name">Channel Name</label>
          <div class="input-group">
            <input
              type="text"
              id="admin-channel-name"
              name="channel_name"
              class="form-control"
              value="{{ event.channel.name if event.channel else '' }}"
              list="admin-channel-options"
              placeholder="Pick or type a channel"
            >
            {% if event.channel %}
            {% if event.channel.visibility == 'private' %}
            {% set channel_url = request.url_for('channel_page_private', slug=event.channel.slug) %}
            {% else %}
            {% set channel_url = request.url_for('channel_page', slug=event.channel.slug) %}
            {% endif %}
            <a class="btn btn-outline-primary" href="{{ channel_url }}">View channel</a>
            {% endif %}
          </div>
          <div class="form-text">Private channels never appear in this list—type them manually. Showing the top public options; type to search beyond the default suggestions.</div>
          <datalist id="admin-channel-options">
            {% for channel in public_channels %}
            <option value="{{ channel.name }}"></option>
            {% endfor %}
          </datalist>
          {% if not event.channel %}
          <div class="small mt-1 text-muted">No channel assigned yet.</div>
          {% endif %}
        </div>
        <div class="mb-3">
          <label class="form-label d-block">Channel Visibility</label>
          {% set current_visibility = event.channel.visibility if event.channel else 'public' %}
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="channel_visibility" id="admin-channel-public" value="public" data-channel-visibility="admin-channel" {% if current_visibility == 'public' %}checked{% endif %}>
            <label class="form-check-label" for="admin-channel-public">Public</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="channel_visibility" id="admin-channel-private" value="private" data-channel-visibility="admin-channel" {% if current_visibility == 'private' %}checked{% endif %}>
            <label class="form-check-label" for="admin-channel-private">Private</label>
          </div>
        </div>
        <div class="alert alert-warning {% if current_visibility != 'private' %}d-none{% endif %}" role="alert" data-channel-alert="admin-channel">
          <div class="fw-semibold">Private channels rely on link secrecy.</div>
          <div class="small mb-0">
            Use a distinctive slug, share it only with trusted people, and keep the full link—there is no login or recovery. Inactive private channels can purge automatically.
          </div>
        </div>
        <div
          class="alert alert-info {% if current_visibility != 'private' %}d-none{% endif %}"
          role="alert"
          data-channel-event-alert="admin-channel"
          data-event-private-toggle="#admin-private"
        >
          <div class="fw-semibold">Private channel: event set to private by default.</div>
          <div class="small mb-0">
            We set the event to private when the channel is private. You can switch it back to public if needed; if you do, the channel stays hidden and will not appear on the event page. Share the channel link separately if you want guests to browse it.
          </div>
        </div>
        <div class="form-check form-switch mb-4">
          <input class="form-check-input" type="checkbox" id="admin-private" name="is_private" value="true" {% if event.is_private %}checked{% endif %}>
          <label class="form-check-label" for="admin-private">Keep this event private (hide from homepage)</label>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-primary" type="submit">Save Event</button>
          <a class="btn btn-outline-secondary" href="/e/{{ event.id }}">Cancel</a>
        </div>
      </form>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="p-4 card-flush rounded-3 shadow-sm mb-4">
      <div class="row row-cols-1 row-cols-sm-3 g-2 mb-3">
        {% set totals = namespace(yes=0, no=0, maybe=0, yes_rsvps=0, maybe_rsvps=0) %}
        {% for rsvp in rsvps %}
          {% set status = (rsvp.status or '').lower() %}
          {% set party_size = (rsvp.guest_count or 0) + 1 %}
          {% if status == 'yes' %}
            {% set totals.yes = totals.yes + party_size %}
            {% set totals.yes_rsvps = totals.yes_rsvps + 1 %}
          {% elif status == 'no' %}
            {% set totals.no = totals.no + party_size %}
          {% elif status == 'maybe' %}
            {% set totals.maybe = totals.maybe + party_size %}
            {% set totals.maybe_rsvps = totals.maybe_rsvps + 1 %}
          {% endif %}
        {% endfor %}
        <div class="col">
          <div class="p-3 h-100 rounded-3 bg-success bg-opacity-10 border border-success border-opacity-50">
            <div class="fw-semibold text-success text-uppercase small">Yes</div>
            <div class="fs-4 text-white">{{ totals.yes }}</div>
            <div class="small text-secondary">{{ totals.yes_rsvps }} RSVP(s)</div>
          </div>
        </div>
        <div class="col">
          <div class="p-3 h-100 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-50">
            <div class="fw-semibold text-warning text-uppercase small">Maybe</div>
            <div class="fs-4 text-white">{{ totals.maybe }}</div>
            <div class="small text-secondary">{{ totals.maybe_rsvps }} RSVP(s)</div>
          </div>
        </div>
        <div class="col">
          <div class="p-3 h-100 rounded-3 bg-light bg-opacity-10 border border-secondary border-opacity-50">
            <div class="fw-semibold text-uppercase small text-secondary">No</div>
            <div class="fs-4 text-white">{{ totals.no }}</div>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <div class="fw-semibold text-white">Shareable links</div>
          <div class="small text-secondary">Keep admin link private.</div>
        </div>
        <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#admin-links" aria-expanded="false" aria-controls="admin-links">
          Toggle
        </button>
      </div>
      <div class="collapse" id="admin-links">
        <div class="small mb-2">
          <div class="fw-semibold text-white">Admin link</div>
          <input type="text" readonly class="form-control form-control-sm mb-2" value="{{ request.url_for('event_admin', event_id=event.id, admin_token=admin_token) }}">
          <div class="text-secondary">Save or bookmark this link. Anyone with it can edit/delete the event.</div>
        </div>
        <div class="small">
          <div class="fw-semibold text-white">Public RSVP page</div>
          <input type="text" readonly class="form-control form-control-sm mb-2" value="{{ request.url_for('event_page', event_id=event.id) }}">
          <div class="text-secondary">Share this with guests. They get their own magic link after RSVPing.</div>
        </div>
      </div>
    </div>
    <div class="p-4 bg-white border rounded-3 shadow-sm">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="h6 text-uppercase text-muted mb-0">RSVPs</h3>
      </div>
      {% if rsvps %}
      <ul class="list-group list-group-flush">
        {% for rsvp in rsvps %}
          <li class="list-group-item d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
              <div class="fw-semibold">{{ rsvp.name }}</div>
              {% if rsvp.pronouns %}<div class="text-muted small">{{ rsvp.pronouns }}</div>{% endif %}
              {% if rsvp.notes %}<div class="text-muted small">Notes: {{ rsvp.notes }}</div>{% endif %}
              <div class="text-muted small">Guests: {{ rsvp.guest_count }}</div>
            </div>
            <div class="text-end">
              <span class="badge bg-secondary text-uppercase">{{ rsvp.status }}</span>
              <form
                method="post"
                action="/e/{{ event.id }}/admin/{{ admin_token }}/rsvp/{{ rsvp.id }}/delete"
                onsubmit="return confirm('Delete this RSVP?');"
              >
                <button class="btn btn-sm btn-outline-danger mt-2" type="submit">Delete</button>
              </form>
            </div>
          </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted mb-0">No RSVPs yet.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
